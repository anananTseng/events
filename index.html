<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç«¯æ°´å¤§æŒ‘æˆ° V9 (ç¶“å…¸æ‰‹æ„Ÿç‰ˆ)</title>
    <style>
        body {
            margin: 0; padding: 0; overflow: hidden;
            background-color: #2c3e50;
            font-family: 'Microsoft JhengHei', sans-serif;
            touch-action: none;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            height: 100vh; color: white;
            user-select: none; -webkit-user-select: none;
        }

        /* --- UI æŒ‰éˆ• --- */
        button { border: none; outline: none; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        .btn-primary { padding: 15px 30px; font-size: 1.1rem; background: #3498db; color: white; border-radius: 10px; margin: 10px; width: 80%; max-width: 300px; }
        .btn-success { padding: 20px 40px; font-size: 1.5rem; background: #2ecc71; color: white; border-radius: 50px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); margin-bottom: 20px;}
        .btn-warning { padding: 15px 30px; font-size: 1.1rem; background: #f39c12; color: white; border-radius: 10px; margin: 10px; width: 80%; max-width: 300px; }

        /* éŠæˆ²å€ */
        #game-area {
            position: relative; width: 300px; height: 300px;
            background: rgba(255, 255, 255, 0.1); border-radius: 50%;
            border: 8px solid #bdc3c7; box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
            display: none; z-index: 5;
        }
        #ball {
            position: absolute; width: 50px; height: 50px;
            background: radial-gradient(circle at 30% 30%, #3498db, #2980b9);
            border-radius: 50%; top: 50%; left: 50%;
            transform: translate(-50%, -50%); box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* ä»‹é¢å±¤ */
        #hud-layer, #action-area, #progress-bar-container { display: none; position: absolute; width: 100%; text-align: center; z-index: 10; }
        #hud-layer { top: 30px; }
        #timer-display { font-size: 2.5rem; font-weight: bold; text-shadow: 2px 2px 0 #000; margin-top: 5px; font-variant-numeric: tabular-nums;}
        #player-badge { background: #f1c40f; color: #333; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 1.2rem; display: inline-block;}
        
        #action-area { bottom: 50px; display: none; justify-content: center; z-index: 20; }
        #action-btn { 
            width: 130px; height: 130px; border-radius: 50%; 
            border: 6px solid rgba(255,255,255,0.2); 
            background: #e74c3c; color: white; 
            font-size: 1.5rem; font-weight: bold; 
            box-shadow: 0 10px 0 #c0392b; 
        }
        
        #progress-bar-container { bottom: 20px; width: 80%; height: 15px; background: #34495e; border-radius: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); }
        #progress-bar { width: 0%; height: 100%; background: #2ecc71; transition: width 0.1s; }

        /* å…¨è¢å¹•è¦†è“‹å±¤ */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; transition: 0.3s; }
        
        #setup-screen { z-index: 200; }
        input[type="text"] { padding: 15px; font-size: 1.5rem; border-radius: 10px; border: none; width: 70%; text-align: center; margin-bottom: 20px;}
        
        #leaderboard-screen { background: #8e44ad; z-index: 300; display: none; }
        #leaderboard-list { width: 95%; max-height: 60vh; overflow-y: auto; background: white; color: #333; border-radius: 10px; margin: 20px 0; padding: 5px; }
        .rank-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 1rem; }
        .rank-row:nth-child(1) { background: #fffbe6; }
        .rank-info { display: flex; flex-direction: column; text-align: left; }
        .rank-date { font-size: 0.8rem; color: #888; margin-top: 2px; }

        #end-screen { background: rgba(0,0,0,0.9); display: none; z-index: 250; }
        .end-title { font-size: 3rem; margin-bottom: 10px; }

        /* æ ¡æº–å„€ */
        #calibration-box {
            width: 150px; height: 150px;
            border: 4px dashed rgba(255,255,255,0.5);
            border-radius: 50%;
            position: relative;
            margin-top: 20px;
            background: rgba(0,0,0,0.3);
            transition: border-color 0.2s;
        }
        #calibration-dot {
            width: 20px; height: 20px;
            background: #e74c3c;
            border-radius: 50%;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            transition: background-color 0.2s;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .calib-ok { border-color: #2ecc71 !important; background: rgba(46, 204, 113, 0.2) !important; }
        .dot-ok { background: #2ecc71 !important; width: 25px !important; height: 25px !important;}

        .loading { color: rgba(255,255,255,0.7); animation: pulse 1s infinite; }
        @keyframes pulse { 0%{opacity:0.5;} 100%{opacity:1;} }
        .danger { border-color: #e74c3c !important; }

    </style>
</head>
<body>

    <div id="setup-screen" class="overlay">
        <h1>âš–ï¸ ç«¯æ°´å¤§æŒ‘æˆ°</h1>
        <p style="margin-bottom: 5px; color:#aaa;">V9.0 ç¶“å…¸æ‰‹æ„Ÿç‰ˆ</p>
        <input type="text" id="input-name" placeholder="è¼¸å…¥åå­—" maxlength="8">
        <button class="btn-success" onclick="checkPermission()">é–‹å§‹æŒ‘æˆ°</button>
        <button class="btn-primary" style="background:none; border:1px solid #aaa;" onclick="showLeaderboard()">ğŸ† è‹±é›„æ¦œ</button>
    </div>

    <div id="ready-screen" class="overlay" style="display:none; background: rgba(44, 62, 80, 0.95);">
        <h2 id="ready-player-display" style="color:#f1c40f;"></h2>
        
        <div id="calibration-box">
            <div id="calibration-dot"></div>
            <div style="position:absolute; top:50%; left:20%; width:60%; height:1px; background:rgba(255,255,255,0.3);"></div>
            <div style="position:absolute; left:50%; top:20%; height:60%; width:1px; background:rgba(255,255,255,0.3);"></div>
            <div style="position:absolute; top:50%; left:50%; width:30px; height:30px; border:1px solid rgba(255,255,255,0.5); border-radius:50%; transform:translate(-50%,-50%);"></div>
        </div>
        <p style="color: #ccc; margin-top: 10px; font-size: 0.9rem;">æ ¡æº–æ°´å¹³ï¼šè«‹å°‡ç´…é»ç§»è‡³ä¸­å¿ƒ</p>

        <div id="countdown-text" style="font-size: 5rem; color: #fff; font-weight: bold; margin-top: 10px;">3</div>
    </div>

    <div id="end-screen" class="overlay">
        <h1 id="end-title" class="end-title"></h1>
        <h2 id="end-score" style="color: #f1c40f;"></h2>
        <div id="upload-status" style="color:#ccc; margin-bottom:20px; height: 1.2em;"></div>
        
        <button class="btn-success" onclick="retryGame()">ğŸ”„ å†ä¾†ä¸€æ¬¡</button>
        <button class="btn-warning" onclick="switchPlayer()">ğŸ‘¥ æ›äººæŒ‘æˆ°</button>
        <button class="btn-primary" onclick="showLeaderboard()">ğŸ† è‹±é›„æ¦œ</button>
    </div>

    <div id="leaderboard-screen" class="overlay">
        <h1>ğŸ… æ­·å²è‹±é›„æ¦œ</h1>
        <div id="loading-text" class="loading">æ­£åœ¨é€£ç·š...</div>
        <div id="leaderboard-list"></div>
        <button class="btn-primary" onclick="closeLeaderboard()">è¿”å›</button>
    </div>

    <div id="hud-layer">
        <div id="player-badge">Player</div>
        <div id="timer-display">0.00</div>
    </div>

    <div id="game-area">
        <div id="ball"></div>
    </div>

    <div id="progress-bar-container"><div id="progress-bar"></div></div>
    
    <div id="action-area">
        <button id="action-btn" ontouchstart="tapTask(event)" onclick="tapTask(event)">é»æ“Š<br>å……èƒ½</button>
    </div>

    <script>
        // API è¨­å®š
        const API_URL = 'https://script.google.com/macros/s/AKfycbz6e0gMIXjlXzbTl0pBeIKbeN7J4F7mEZSzI0SfJ0gPkTW3HNvqp6JNy_mEMnZDwz4/exec';

        // DOM å…ƒç´ 
        const playerNameInput = document.getElementById('input-name');
        const setupScreen = document.getElementById('setup-screen');
        const readyScreen = document.getElementById('ready-screen');
        const endScreen = document.getElementById('end-screen');
        const leaderboardScreen = document.getElementById('leaderboard-screen');
        const leaderboardList = document.getElementById('leaderboard-list');
        const loadingText = document.getElementById('loading-text');

        const gameArea = document.getElementById('game-area');
        const ball = document.getElementById('ball');
        const hudLayer = document.getElementById('hud-layer');
        const actionArea = document.getElementById('action-area');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const timerDisplay = document.getElementById('timer-display');
        const playerBadge = document.getElementById('player-badge');
        const progressBar = document.getElementById('progress-bar');
        const actionBtn = document.getElementById('action-btn');
        const uploadStatus = document.getElementById('upload-status');
        
        const calibBox = document.getElementById('calibration-box');
        const calibDot = document.getElementById('calibration-dot');

        let playerName = "";
        let isPlaying = false;
        let isCalibrating = false;
        let startTime = 0;
        let timerInterval;
        
        let ballX = 0, ballY = 0;
        let velocityX = 0, velocityY = 0;
        let tiltX = 0, tiltY = 0;
        let taskProgress = 0;
        const taskGoal = 20; 
        const maxRadius = 120;

        // 1. æ¬Šé™
        function checkPermission() {
            const name = playerNameInput.value.trim();
            if (!name) { alert("è«‹å…ˆè¼¸å…¥åå­—ï¼"); return; }
            playerName = name;
            playerBadge.innerText = playerName;

            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            prepareGame();
                        } else {
                            alert("è«‹å…è¨±å‹•ä½œåµæ¸¬æ¬Šé™");
                        }
                    })
                    .catch(console.error);
            } else {
                prepareGame();
            }
        }

        // 2. æº–å‚™èˆ‡æ ¡æº–
        function prepareGame() {
            setupScreen.style.display = 'none';
            endScreen.style.display = 'none';
            leaderboardScreen.style.display = 'none';
            readyScreen.style.display = 'flex';
            
            document.getElementById('ready-player-display').innerText = `é¸æ‰‹ï¼š${playerName}`;
            
            ballX = 0; ballY = 0; velocityX = 0; velocityY = 0;
            taskProgress = 0;
            progressBar.style.width = "0%";
            gameArea.classList.remove('danger');
            
            isCalibrating = true;
            window.addEventListener('deviceorientation', handleOrientation);
            requestAnimationFrame(gameLoop);

            let count = 3;
            const countText = document.getElementById('countdown-text');
            countText.innerText = count;

            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    countText.innerText = count;
                    if(navigator.vibrate) navigator.vibrate(50);
                } else {
                    clearInterval(timer);
                    isCalibrating = false;
                    startGame();
                }
            }, 1000);
        }

        function startGame() {
            readyScreen.style.display = 'none';
            gameArea.style.display = 'block';
            hudLayer.style.display = 'block';
            actionArea.style.display = 'flex';
            progressBarContainer.style.display = 'block';

            // ç¢ºä¿é‡ç½®
            ballX = 0; ballY = 0;
            velocityX = 0; velocityY = 0;

            isPlaying = true;
            startTime = Date.now();
            if(navigator.vibrate) navigator.vibrate(200);

            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                timerDisplay.innerText = elapsed.toFixed(2);
            }, 50);
        }

        // 3. ç‰©ç†èˆ‡æ ¡æº–é‚è¼¯ (é‚„åŸç‚ºæœ€åŸå§‹ç‰ˆæœ¬)
        function handleOrientation(event) {
            let x = event.gamma; 
            let y = event.beta;
            
            // ç§»é™¤æ‰€æœ‰æ­»å€åˆ¤æ–·ï¼Œä¿æŒæœ€åŸå§‹éˆæ•åº¦
            
            if (x > 45) x = 45; if (x < -45) x = -45;
            if (y > 45) y = 45; if (y < -45) y = -45;
            
            tiltX = x; tiltY = y;
        }

        function gameLoop() {
            requestAnimationFrame(gameLoop);

            // A. æ ¡æº–æ¨¡å¼
            if (isCalibrating) {
                let dotX = tiltX * 1.5; 
                let dotY = tiltY * 1.5;
                const limit = 65;
                if (dotX > limit) dotX = limit; if (dotX < -limit) dotX = -limit;
                if (dotY > limit) dotY = limit; if (dotY < -limit) dotY = -limit;
                calibDot.style.transform = `translate(calc(-50% + ${dotX}px), calc(-50% + ${dotY}px))`;
                const dist = Math.sqrt(dotX*dotX + dotY*dotY);
                if (dist < 15) {
                    calibBox.classList.add('calib-ok');
                    calibDot.classList.add('dot-ok');
                } else {
                    calibBox.classList.remove('calib-ok');
                    calibDot.classList.remove('dot-ok');
                }
                return; 
            }

            // B. éŠæˆ²æ¨¡å¼
            if (!isPlaying) return;

            // --- ç‰©ç†é‚„åŸå€ ---
            
            // ä½¿ç”¨æœ€ç¶“å…¸çš„ä¿‚æ•¸ï¼š0.05 (éˆæ•)
            velocityX += tiltX * 0.05; 
            velocityY += tiltY * 0.05;
            
            // ä½¿ç”¨æœ€ç¶“å…¸çš„æ‘©æ“¦åŠ›ï¼š0.92 (æµæš¢)
            velocityX *= 0.92; 
            velocityY *= 0.92;
            
            // -----------------

            ballX += velocityX; ballY += velocityY;

            const dist = Math.sqrt(ballX * ballX + ballY * ballY);
            if (dist > maxRadius) {
                endGame(false);
            } else {
                ball.style.transform = `translate(calc(-50% + ${ballX}px), calc(-50% + ${ballY}px))`;
                if (dist > maxRadius * 0.8) {
                    gameArea.classList.add('danger');
                    timerDisplay.style.color = "#e74c3c";
                } else {
                    gameArea.classList.remove('danger');
                    timerDisplay.style.color = "white";
                }
            }
        }

        // 4. é˜²ä½œå¼Šé»æ“Š (ä¿æŒé©ä¸­é›£åº¦)
        function tapTask(e) {
            e.preventDefault();
            if (!isPlaying) return;

            let intensity = taskProgress / taskGoal;
            
            // é…åˆè¼•ç›ˆçš„ç‰©ç†å¼•æ“ï¼Œè¸¢çƒåŠ›é“ä¸èƒ½å¤ªå¼·ï¼Œå¦å‰‡å¿…æ­»
            // è¨­å®šç‚º 8 ~ 20 (é©ä¸­)
            let kickForce = 8 + (intensity * 12); 
            
            velocityX += (Math.random() - 0.5) * kickForce;
            velocityY += (Math.random() - 0.5) * kickForce;

            if(navigator.vibrate) {
                navigator.vibrate(30 + (intensity * 100));
            }

            taskProgress++;
            progressBar.style.width = (taskProgress / taskGoal) * 100 + "%";
            
            actionBtn.style.transform = "scale(0.9)";
            setTimeout(() => actionBtn.style.transform = "scale(1)", 50);

            if (taskProgress >= taskGoal) {
                endGame(true);
            }
        }

        function endGame(isWin) {
            isPlaying = false;
            clearInterval(timerInterval);
            
            const finalTime = ((Date.now() - startTime) / 1000).toFixed(2);
            
            gameArea.style.display = 'none';
            hudLayer.style.display = 'none';
            actionArea.style.display = 'none';
            progressBarContainer.style.display = 'none';
            endScreen.style.display = 'flex';
            
            const titleEl = document.getElementById('end-title');
            const scoreEl = document.getElementById('end-score');
            
            if (isWin) {
                titleEl.innerText = "ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼";
                titleEl.style.color = "#2ecc71";
                scoreEl.innerText = `${finalTime} ç§’`;
                if(navigator.vibrate) navigator.vibrate([100,100,200]);
                uploadScore(playerName, finalTime);
            } else {
                titleEl.innerText = "ğŸ’¥ ç¢äº†ï¼";
                titleEl.style.color = "#e74c3c";
                scoreEl.innerText = "æ·˜æ±° (DNF)";
                uploadStatus.innerText = "";
                if(navigator.vibrate) navigator.vibrate(1000);
            }
        }

        function uploadScore(name, time) {
            uploadStatus.innerText = "æ­£åœ¨ä¸Šå‚³æˆç¸¾...";
            const url = `${API_URL}?action=add&name=${encodeURIComponent(name)}&time=${time}`;
            fetch(url)
                .then(res => res.text())
                .then(data => { uploadStatus.innerText = "âœ… æˆç¸¾å·²ä¸Šå‚³"; })
                .catch(err => { uploadStatus.innerText = "âš ï¸ ä¸Šå‚³å¤±æ•—"; });
        }

        function retryGame() { prepareGame(); }
        function switchPlayer() { endScreen.style.display = 'none'; setupScreen.style.display = 'flex'; playerNameInput.value = ""; }
        function showLeaderboard() { setupScreen.style.display = 'none'; endScreen.style.display = 'none'; leaderboardScreen.style.display = 'flex'; fetchLeaderboard(); }
        function closeLeaderboard() {
            leaderboardScreen.style.display = 'none';
            if (!playerName) setupScreen.style.display = 'flex';
            else if (document.getElementById('end-title').innerText) endScreen.style.display = 'flex';
            else setupScreen.style.display = 'flex';
        }

        function fetchLeaderboard() {
            loadingText.style.display = 'block';
            leaderboardList.innerHTML = "";
            
            fetch(`${API_URL}?action=get`)
                .then(res => res.json())
                .then(data => {
                    loadingText.style.display = 'none';
                    renderLeaderboard(data);
                })
                .catch(err => { loadingText.innerText = "è®€å–å¤±æ•—"; });
        }

        function renderLeaderboard(data) {
            let html = '';
            if (data.length === 0) {
                html = '<div style="padding:20px; color:#777;">æš«ç„¡è³‡æ–™</div>';
            } else {
                data.forEach((item, index) => {
                    let rank = index + 1;
                    let medal = index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : (index === 2 ? 'ğŸ¥‰' : rank + '.'));
                    let style = item.name === playerName ? 'background:#dff9fb;' : '';
                    let dateStr = "";
                    if (item.date) {
                        let d = new Date(item.date);
                        dateStr = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                    }
                    html += `
                        <div class="rank-row" style="${style}">
                            <div class="rank-info">
                                <span style="font-weight:bold; font-size:1.1rem;">${medal} ${item.name}</span>
                                <span class="rank-date">${dateStr}</span>
                            </div>
                            <span style="font-weight:bold; color:#34495e;">${item.time} ç§’</span>
                        </div>
                    `;
                });
            }
            leaderboardList.innerHTML = html;
        }
    </script>
</body>
</html>
