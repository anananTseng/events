<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç«¯æ°´å¤§æŒ‘æˆ° (é˜²ä½œå¼Šç‰ˆ)</title>
    <style>
        body {
            margin: 0; padding: 0; overflow: hidden;
            background-color: #2c3e50;
            font-family: 'Microsoft JhengHei', sans-serif;
            touch-action: none;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            height: 100vh; color: white;
            user-select: none; -webkit-user-select: none;
        }

        /* --- UI æŒ‰éˆ• --- */
        button { border: none; outline: none; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        
        .btn-primary { padding: 15px 30px; font-size: 1.1rem; background: #3498db; color: white; border-radius: 10px; margin: 10px; width: 80%; max-width: 300px; }
        .btn-success { padding: 20px 40px; font-size: 1.5rem; background: #2ecc71; color: white; border-radius: 50px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); margin-bottom: 20px;}
        .btn-warning { padding: 15px 30px; font-size: 1.1rem; background: #f39c12; color: white; border-radius: 10px; margin: 10px; width: 80%; max-width: 300px; }

        /* éŠæˆ²å€ */
        #game-area {
            position: relative; width: 300px; height: 300px;
            background: rgba(255, 255, 255, 0.1); border-radius: 50%;
            border: 8px solid #bdc3c7; box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
            display: none; z-index: 5;
        }
        #ball {
            position: absolute; width: 50px; height: 50px;
            background: radial-gradient(circle at 30% 30%, #3498db, #2980b9);
            border-radius: 50%; top: 50%; left: 50%;
            transform: translate(-50%, -50%); box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* HUD èˆ‡ æ“ä½œ */
        #hud-layer, #action-area, #progress-bar-container { display: none; position: absolute; width: 100%; text-align: center; z-index: 10; }
        #hud-layer { top: 30px; }
        #timer-display { font-size: 2.5rem; font-weight: bold; text-shadow: 2px 2px 0 #000; margin-top: 5px; font-variant-numeric: tabular-nums;}
        #player-badge { background: #f1c40f; color: #333; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 1.2rem; display: inline-block;}
        
        #action-area { bottom: 50px; display: none; justify-content: center; z-index: 20; }
        #action-btn { 
            width: 130px; height: 130px; border-radius: 50%; 
            border: 6px solid rgba(255,255,255,0.2); 
            background: #e74c3c; color: white; 
            font-size: 1.5rem; font-weight: bold; 
            box-shadow: 0 10px 0 #c0392b; 
        }
        
        #progress-bar-container { bottom: 20px; width: 80%; height: 15px; background: #34495e; border-radius: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); }
        #progress-bar { width: 0%; height: 100%; background: #2ecc71; transition: width 0.1s; }

        /* Overlays (å…¨è¢å¹•å±¤) */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; transition: 0.3s; }
        
        #setup-screen { z-index: 200; }
        input[type="text"] { padding: 15px; font-size: 1.5rem; border-radius: 10px; border: none; width: 70%; text-align: center; margin-bottom: 20px;}
        
        #leaderboard-screen { background: #8e44ad; z-index: 300; display: none; }
        #leaderboard-list { width: 90%; max-height: 50vh; overflow-y: auto; background: white; color: #333; border-radius: 10px; margin: 20px 0; padding: 10px; }
        .rank-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; font-size: 1.2rem; }
        .rank-row:nth-child(1) { background: #f1c40f; font-weight: bold; }

        #end-screen { background: rgba(0,0,0,0.9); display: none; z-index: 250; }
        .end-title { font-size: 3rem; margin-bottom: 10px; }

        .loading { color: rgba(255,255,255,0.7); animation: pulse 1s infinite; }
        @keyframes pulse { 0%{opacity:0.5;} 100%{opacity:1;} }
        
        .danger { border-color: #e74c3c !important; }

    </style>
</head>
<body>

    <div id="setup-screen" class="overlay">
        <h1>âš–ï¸ ç«¯æ°´å¤§æŒ‘æˆ°</h1>
        <p style="margin-bottom: 5px; color:#aaa;">é˜²ä½œå¼Šç‰ˆ V6.0</p>
        <input type="text" id="input-name" placeholder="è¼¸å…¥åå­—/ä»£è™Ÿ" maxlength="8">
        <button class="btn-success" onclick="checkPermission()">é–‹å§‹æŒ‘æˆ°</button>
        <button class="btn-primary" style="background:none; border:1px solid #aaa;" onclick="showLeaderboard()">ğŸ† æ­·å²æ’è¡Œæ¦œ</button>
    </div>

    <div id="ready-screen" class="overlay" style="display:none; background: rgba(44, 62, 80, 0.95);">
        <h2 id="ready-player-display" style="color:#f1c40f;"></h2>
        <div id="countdown-text" style="font-size: 8rem; color: #fff; font-weight: bold;">3</div>
        <p style="color: #ccc; margin-top: 20px;">æ‰‹æ©Ÿå¹³æ”¾ãƒ»æº–å‚™å¹³è¡¡</p>
    </div>

    <div id="end-screen" class="overlay">
        <h1 id="end-title" class="end-title"></h1>
        <h2 id="end-score" style="color: #f1c40f;"></h2>
        <div id="upload-status" style="color:#ccc; margin-bottom:20px; height: 1.2em;"></div>
        
        <button class="btn-success" onclick="retryGame()">ğŸ”„ å†ä¾†ä¸€æ¬¡ (åŒä¸€å€‹äºº)</button>
        <button class="btn-warning" onclick="switchPlayer()">ğŸ‘¥ æ›ä¸‹ä¸€ä½ (è¼¸å…¥åå­—)</button>
        <button class="btn-primary" onclick="showLeaderboard()">ğŸ† æŸ¥çœ‹æ’è¡Œæ¦œ</button>
    </div>

    <div id="leaderboard-screen" class="overlay">
        <h1>ğŸ… æ­·å²è‹±é›„æ¦œ</h1>
        <div id="loading-text" class="loading">æ­£åœ¨é€£ç·šè‡³é›²ç«¯...</div>
        <div id="leaderboard-list"></div>
        <button class="btn-primary" onclick="closeLeaderboard()">è¿”å›</button>
    </div>

    <div id="hud-layer">
        <div id="player-badge">Player</div>
        <div id="timer-display">0.00</div>
    </div>

    <div id="game-area">
        <div id="ball"></div>
    </div>

    <div id="progress-bar-container"><div id="progress-bar"></div></div>
    
    <div id="action-area">
        <button id="action-btn" ontouchstart="tapTask(event)" onclick="tapTask(event)">é»æ“Š<br>å……èƒ½</button>
    </div>

    <script>
        // è¨­å®šæ‚¨çš„ API
        const API_URL = 'https://script.google.com/macros/s/AKfycbz6e0gMIXjlXzbTl0pBeIKbeN7J4F7mEZSzI0SfJ0gPkTW3HNvqp6JNy_mEMnZDwz4/exec';

        // è®Šæ•¸
        const playerNameInput = document.getElementById('input-name');
        const setupScreen = document.getElementById('setup-screen');
        const readyScreen = document.getElementById('ready-screen');
        const endScreen = document.getElementById('end-screen');
        const leaderboardScreen = document.getElementById('leaderboard-screen');
        const leaderboardList = document.getElementById('leaderboard-list');
        const loadingText = document.getElementById('loading-text');

        const gameArea = document.getElementById('game-area');
        const ball = document.getElementById('ball');
        const hudLayer = document.getElementById('hud-layer');
        const actionArea = document.getElementById('action-area');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const timerDisplay = document.getElementById('timer-display');
        const playerBadge = document.getElementById('player-badge');
        const progressBar = document.getElementById('progress-bar');
        const actionBtn = document.getElementById('action-btn');
        const uploadStatus = document.getElementById('upload-status');

        let playerName = "";
        let isPlaying = false;
        let startTime = 0;
        let timerInterval;
        
        // ç‰©ç†è®Šæ•¸
        let ballX = 0, ballY = 0;
        let velocityX = 0, velocityY = 0;
        let tiltX = 0, tiltY = 0;
        let taskProgress = 0;
        const taskGoal = 20; // å¢åŠ åˆ°20ä¸‹ï¼Œè®“é›£åº¦æ›²ç·šæ›´æ˜é¡¯
        const maxRadius = 120;

        // 1. åˆå§‹åŒ–èˆ‡æ¬Šé™
        function checkPermission() {
            const name = playerNameInput.value.trim();
            if (!name) { alert("è«‹å…ˆè¼¸å…¥åå­—ï¼"); return; }
            playerName = name;
            playerBadge.innerText = playerName;

            // iOS æ¬Šé™è«‹æ±‚
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            prepareGame();
                        } else {
                            alert("å¿…é ˆå…è¨±å‹•ä½œåµæ¸¬æ‰èƒ½ç©å–”ï¼");
                        }
                    })
                    .catch(console.error);
            } else {
                prepareGame();
            }
        }

        // 2. æº–å‚™æµç¨‹
        function prepareGame() {
            setupScreen.style.display = 'none';
            endScreen.style.display = 'none';
            leaderboardScreen.style.display = 'none';
            readyScreen.style.display = 'flex';
            
            document.getElementById('ready-player-display').innerText = `é¸æ‰‹ï¼š${playerName}`;
            
            // é‡ç½®éŠæˆ²åƒæ•¸
            ballX = 0; ballY = 0; velocityX = 0; velocityY = 0;
            taskProgress = 0;
            progressBar.style.width = "0%";
            gameArea.classList.remove('danger');
            
            // å•Ÿå‹•ç›£è½ (å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡)
            window.addEventListener('deviceorientation', handleOrientation);
            // å•Ÿå‹•å¼•æ“
            requestAnimationFrame(gameLoop);

            // å€’æ•¸
            let count = 3;
            const countText = document.getElementById('countdown-text');
            countText.innerText = count;

            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    countText.innerText = count;
                    if(navigator.vibrate) navigator.vibrate(50);
                } else {
                    clearInterval(timer);
                    startGame();
                }
            }, 1000);
        }

        function startGame() {
            readyScreen.style.display = 'none';
            gameArea.style.display = 'block';
            hudLayer.style.display = 'block';
            actionArea.style.display = 'flex';
            progressBarContainer.style.display = 'block';

            isPlaying = true;
            startTime = Date.now();
            if(navigator.vibrate) navigator.vibrate(200);

            // è¨ˆæ™‚å™¨
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                timerDisplay.innerText = elapsed.toFixed(2);
            }, 50); // æ›´æ–°é »ç‡å¿«ä¸€é»
        }

        // 3. ç‰©ç†å¼•æ“ (é™€èºå„€)
        function handleOrientation(event) {
            let x = event.gamma; // å·¦å³
            let y = event.beta;  // å‰å¾Œ
            // é™åˆ¶æœ€å¤§å‚¾æ–œè§’åº¦
            if (x > 45) x = 45; if (x < -45) x = -45;
            if (y > 45) y = 45; if (y < -45) y = -45;
            tiltX = x; tiltY = y;
        }

        function gameLoop() {
            requestAnimationFrame(gameLoop);
            if (!isPlaying) return;

            // ç‰©ç†è¨ˆç®—
            velocityX += tiltX * 0.05; 
            velocityY += tiltY * 0.05;
            
            // æ‘©æ“¦åŠ›
            velocityX *= 0.92; 
            velocityY *= 0.92;
            
            ballX += velocityX; 
            ballY += velocityY;

            const dist = Math.sqrt(ballX * ballX + ballY * ballY);
            
            // é‚Šç•Œåˆ¤å®š
            if (dist > maxRadius) {
                endGame(false);
            } else {
                ball.style.transform = `translate(calc(-50% + ${ballX}px), calc(-50% + ${ballY}px))`;
                
                // è¦–è¦ºè­¦ç¤º
                if (dist > maxRadius * 0.8) {
                    gameArea.classList.add('danger');
                    timerDisplay.style.color = "#e74c3c";
                } else {
                    gameArea.classList.remove('danger');
                    timerDisplay.style.color = "white";
                }
            }
        }

        // 4. é˜²ä½œå¼Šé»æ“Šæ©Ÿåˆ¶ (æ ¸å¿ƒä¿®æ”¹)
        function tapTask(e) {
            e.preventDefault();
            if (!isPlaying) return;

            // --- é˜²ä½œå¼Šé‚è¼¯ ---
            // è¨ˆç®—ç›®å‰é€²åº¦ç™¾åˆ†æ¯” (0.0 ~ 1.0)
            let intensity = taskProgress / taskGoal;
            
            // åŸºç¤å¹²æ“¾åŠ›é“ + é€²éšåŠ›é“ (å……èƒ½è¶Šæ»¿ï¼Œè¸¢å¾—è¶Šå¤§åŠ›)
            // åŸºç¤ 10ï¼Œæ»¿èƒ½é‡æ™‚é¡å¤–åŠ  40 -> æœ€é«˜ 50 çš„åŠ›é“
            let kickForce = 15 + (intensity * 40); 
            
            // çµ¦äºˆéš¨æ©Ÿæ–¹å‘çš„çŒ›çƒˆæ¨åŠ›
            velocityX += (Math.random() - 0.5) * kickForce;
            velocityY += (Math.random() - 0.5) * kickForce;

            // éœ‡å‹•å›é¥‹ (å……èƒ½è¶Šæ»¿ï¼Œéœ‡å‹•è¶Šä¹…)
            // åŸºç¤ 50msï¼Œæ»¿èƒ½é‡æ™‚ 200ms
            if(navigator.vibrate) {
                navigator.vibrate(50 + (intensity * 150));
            }
            // -----------------

            taskProgress++;
            progressBar.style.width = (taskProgress / taskGoal) * 100 + "%";
            
            // æŒ‰éˆ•è¦–è¦ºç¸®æ”¾
            actionBtn.style.transform = "scale(0.9)";
            setTimeout(() => actionBtn.style.transform = "scale(1)", 50);

            if (taskProgress >= taskGoal) {
                endGame(true);
            }
        }

        // 5. éŠæˆ²çµæŸè™•ç† (æ•´åˆ)
        function endGame(isWin) {
            isPlaying = false;
            clearInterval(timerInterval);
            
            const finalTime = ((Date.now() - startTime) / 1000).toFixed(2);
            
            // éš±è—éŠæˆ²ä»‹é¢
            gameArea.style.display = 'none';
            hudLayer.style.display = 'none';
            actionArea.style.display = 'none';
            progressBarContainer.style.display = 'none';
            
            // é¡¯ç¤ºçµç®—ç•«é¢
            endScreen.style.display = 'flex';
            
            const titleEl = document.getElementById('end-title');
            const scoreEl = document.getElementById('end-score');
            
            if (isWin) {
                titleEl.innerText = "ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼";
                titleEl.style.color = "#2ecc71";
                scoreEl.innerText = `${finalTime} ç§’`;
                if(navigator.vibrate) navigator.vibrate([100,100,200]);
                
                // è‡ªå‹•ä¸Šå‚³æˆç¸¾
                uploadScore(playerName, finalTime);
            } else {
                titleEl.innerText = "ğŸ’¥ ç¢äº†ï¼";
                titleEl.style.color = "#e74c3c";
                scoreEl.innerText = "æ·˜æ±° (DNF)";
                uploadStatus.innerText = ""; // å¤±æ•—ä¸ä¸Šå‚³ï¼Œæˆ–è€…æ‚¨å¯ä»¥é¸æ“‡ä¸Šå‚³
                if(navigator.vibrate) navigator.vibrate(1000);
            }
        }

        // 6. è³‡æ–™ä¸Šå‚³
        function uploadScore(name, time) {
            uploadStatus.innerText = "æ­£åœ¨ä¸Šå‚³æˆç¸¾...";
            const url = `${API_URL}?action=add&name=${encodeURIComponent(name)}&time=${time}`;

            fetch(url)
                .then(res => res.text())
                .then(data => {
                    uploadStatus.innerText = "âœ… æˆç¸¾å·²ä¸Šå‚³é›²ç«¯";
                })
                .catch(err => {
                    console.error(err);
                    uploadStatus.innerText = "âš ï¸ ä¸Šå‚³å¤±æ•— (è«‹æª¢æŸ¥ç¶²è·¯)";
                });
        }

        // 7. æµç¨‹æ§åˆ¶ (æŒ‰éˆ•åŠŸèƒ½)
        function retryGame() {
            // ç›´æ¥é‡æ–°é–‹å§‹ (åŒå)
            prepareGame();
        }

        function switchPlayer() {
            // å›åˆ°è¼¸å…¥åå­—ç•«é¢
            endScreen.style.display = 'none';
            setupScreen.style.display = 'flex';
            playerNameInput.value = ""; // æ¸…ç©ºåå­—
        }

        function showLeaderboard() {
            setupScreen.style.display = 'none';
            endScreen.style.display = 'none';
            leaderboardScreen.style.display = 'flex';
            fetchLeaderboard();
        }

        function closeLeaderboard() {
            leaderboardScreen.style.display = 'none';
            // å¦‚æœæ˜¯åœ¨ setup éšæ®µæŒ‰çš„ï¼Œå› setup
            // å¦‚æœæ˜¯åœ¨ end éšæ®µæŒ‰çš„ï¼Œå› end
            if (!playerName) {
                setupScreen.style.display = 'flex';
            } else {
                // ç°¡å–®åˆ¤æ–·ï¼šå¦‚æœæœ‰æˆç¸¾é¡¯ç¤ºï¼Œå°±å›çµç®—ç•«é¢ï¼Œå¦å‰‡å› setup
                if (document.getElementById('end-title').innerText) {
                    endScreen.style.display = 'flex';
                } else {
                    setupScreen.style.display = 'flex';
                }
            }
        }

        function fetchLeaderboard() {
            loadingText.style.display = 'block';
            leaderboardList.innerHTML = "";
            
            fetch(`${API_URL}?action=get`)
                .then(res => res.json())
                .then(data => {
                    loadingText.style.display = 'none';
                    renderLeaderboard(data);
                })
                .catch(err => {
                    loadingText.innerText = "è®€å–å¤±æ•—";
                });
        }

        function renderLeaderboard(data) {
            let html = '';
            if (data.length === 0) {
                html = '<div style="padding:20px; color:#777;">æš«ç„¡è³‡æ–™</div>';
            } else {
                data.forEach((item, index) => {
                    let rank = index + 1;
                    let medal = index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : (index === 2 ? 'ğŸ¥‰' : rank + '.'));
                    // æ¨™è¨˜ç›®å‰ç©å®¶
                    let style = item.name === playerName ? 'background:#dff9fb;' : '';
                    
                    html += `
                        <div class="rank-row" style="${style}">
                            <span>${medal} ${item.name}</span>
                            <span>${item.time} ç§’</span>
                        </div>
                    `;
                });
            }
            leaderboardList.innerHTML = html;
        }
    </script>
</body>
</html>
