<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç«¯æ°´å¤§æŒ‘æˆ° V2</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #2c3e50;
            font-family: 'Microsoft JhengHei', sans-serif;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: white;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-area {
            position: relative;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border: 8px solid #bdc3c7;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
            transition: border-color 0.2s, background-color 0.2s;
        }

        #ball {
            position: absolute;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #3498db, #2980b9);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 5;
        }

        /* é–å®šç‹€æ…‹çš„çƒ */
        .ball-locked {
            filter: grayscale(100%);
            transform: translate(-50%, -50%) scale(0.8) !important;
        }

        #ui-layer {
            position: absolute;
            top: 40px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 10;
        }

        #status {
            font-size: 1.8rem;
            font-weight: 900;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        #sub-status {
            font-size: 1.2rem;
            color: #f1c40f;
            text-shadow: 1px 1px 2px black;
        }

        #action-area {
            position: absolute;
            bottom: 60px;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 20;
        }

        #action-btn {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            border: 6px solid rgba(255,255,255,0.2);
            background: #e74c3c;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 10px 0 #c0392b, 0 10px 20px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: transform 0.1s;
            display: none; /* é–‹å§‹å¾Œé¡¯ç¤º */
        }
        
        #action-btn:active {
            transform: translateY(5px);
            box-shadow: 0 5px 0 #c0392b;
        }

        #action-btn:disabled {
            background: #95a5a6;
            box-shadow: 0 5px 0 #7f8c8d;
            transform: translateY(5px);
            color: #bdc3c7;
        }

        #progress-bar-container {
            position: absolute;
            bottom: 30px;
            width: 80%;
            height: 15px;
            background: #34495e;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.2);
            display: none;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background: #2ecc71;
            transition: width 0.1s;
        }

        #start-overlay, #fail-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        #fail-overlay { display: none; background: rgba(192, 57, 43, 0.95); }
        
        .btn-large {
            padding: 20px 50px;
            font-size: 1.5rem;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            margin-top: 20px;
        }

        .danger { border-color: #e74c3c !important; background: rgba(231, 76, 60, 0.3) !important; }
        .success { border-color: #2ecc71 !important; background: rgba(46, 204, 113, 0.2) !important; }

    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="status">æº–å‚™é–‹å§‹</div>
        <div id="sub-status">è«‹ä¿æŒæ‰‹æ©Ÿæ°´å¹³</div>
    </div>

    <div id="game-area">
        <div id="ball"></div>
    </div>

    <div id="progress-bar-container">
        <div id="progress-bar"></div>
    </div>

    <div id="action-area">
        <button id="action-btn" ontouchstart="tapTask(event)" onclick="tapTask(event)">é»æˆ‘<br>å……èƒ½</button>
    </div>

    <div id="start-overlay">
        <h1 style="font-size: 2.5rem; margin-bottom: 10px;">âš–ï¸ ç«¯æ°´å¤§æŒ‘æˆ°</h1>
        <p>1. å¹³æ”¾æ‰‹æ©Ÿ 2. é»æ“ŠæŒ‰éˆ•å……èƒ½ 3. å‚³çµ¦ä¸‹ä¸€ä½</p>
        <button class="btn-large" onclick="requestPermission()">é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="fail-overlay">
        <h1 style="font-size: 4rem; margin:0;">ğŸ’¥</h1>
        <h2>ç¢æ‰äº†ï¼</h2>
        <button class="btn-large" style="background:#f1c40f; color:#333;" onclick="restartGame()">é‡æ–°é–‹å§‹</button>
    </div>

    <script>
        // DOM å…ƒç´ 
        const ball = document.getElementById('ball');
        const gameArea = document.getElementById('game-area');
        const statusEl = document.getElementById('status');
        const subStatusEl = document.getElementById('sub-status');
        const actionBtn = document.getElementById('action-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-bar-container');
        const startOverlay = document.getElementById('start-overlay');
        const failOverlay = document.getElementById('fail-overlay');

        // éŠæˆ²ç‹€æ…‹è®Šæ•¸
        let isPlaying = false;
        let isPassing = false; // æ˜¯å¦æ­£åœ¨å‚³éä¸­
        let ballX = 0, ballY = 0;
        let velocityX = 0, velocityY = 0;
        let tiltX = 0, tiltY = 0; // åŸå§‹é™€èºå„€æ•¸æ“š
        const maxRadius = 120; // é‚Šç•Œ (Game 150 - Ball 25 - Padding)
        
        let taskProgress = 0;
        const taskGoal = 10; // æ¯æ¬¡éœ€è¦é»æ“Šçš„æ¬¡æ•¸

        // iOS æ¬Šé™è«‹æ±‚
        function requestPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            initGame();
                        } else {
                            alert('å¿…é ˆå…è¨±å‹•ä½œåµæ¸¬æ‰èƒ½ç©å–”ï¼');
                        }
                    })
                    .catch(console.error);
            } else {
                initGame();
            }
        }

        function initGame() {
            startOverlay.style.display = 'none';
            actionBtn.style.display = 'block';
            progressContainer.style.display = 'block';
            
            // å•Ÿå‹•ç›£è½å™¨
            window.addEventListener('deviceorientation', handleOrientation);
            
            // å•Ÿå‹•æ°¸ä¹…å¾ªç’°å¼•æ“ (ä¿®å¾© Bug çš„é—œéµ)
            requestAnimationFrame(gameLoop);
            
            resetRound();
        }

        // è™•ç†é™€èºå„€æ•¸æ“š (åªå­˜æ•¸æ“šï¼Œä¸è™•ç†é‚è¼¯)
        function handleOrientation(event) {
            // beta: å‰å¾Œ, gamma: å·¦å³
            // é‡å°ä¸åŒè£ç½®æ–¹å‘ç¨å¾®èª¿æ•´ï¼Œé€™è£¡ä½¿ç”¨åŸºæœ¬é‚è¼¯
            let x = event.gamma; 
            let y = event.beta;

            // é™åˆ¶æœ€å¤§å‚¾æ–œè§’åº¦ï¼Œé¿å…çƒé£›å¤ªå¿«
            if (x > 40) x = 40; if (x < -40) x = -40;
            if (y > 40) y = 40; if (y < -40) y = -40;

            tiltX = x;
            tiltY = y;
        }

        // æ ¸å¿ƒéŠæˆ²å¼•æ“ (æ°¸é é‹è¡Œ)
        function gameLoop() {
            // æŒçºŒå‘¼å«ä¸‹ä¸€å¹€ï¼Œç¢ºä¿å¼•æ“ä¸ç†„ç«
            requestAnimationFrame(gameLoop);

            // å¦‚æœä¸æ˜¯éŠç©ç‹€æ…‹ (ä¾‹å¦‚å‚³éä¸­æˆ–å¤±æ•—)ï¼Œå°±ä¸è¨ˆç®—ç‰©ç†
            if (!isPlaying) return;

            // ç‰©ç†è¨ˆç®—
            velocityX += tiltX * 0.05;
            velocityY += tiltY * 0.05;

            // æ‘©æ“¦åŠ› (è®“çƒä¸æœƒæ°¸é æ»‘å‹•)
            velocityX *= 0.92;
            velocityY *= 0.92;

            // æ›´æ–°ä½ç½®
            ballX += velocityX;
            ballY += velocityY;

            // è¨ˆç®—è·é›¢ä¸­å¿ƒçš„è·é›¢
            const dist = Math.sqrt(ballX * ballX + ballY * ballY);

            // é‚Šç•Œæª¢æ¸¬
            if (dist > maxRadius) {
                triggerGameOver();
            } else {
                // æ›´æ–°ç•«é¢
                ball.style.transform = `translate(calc(-50% + ${ballX}px), calc(-50% + ${ballY}px))`;
                
                // å±éšªè­¦ç¤º
                if (dist > maxRadius * 0.7) {
                    gameArea.classList.add('danger');
                    statusEl.innerText = "å±éšªï¼ï¼å›æ­£ï¼ï¼";
                    statusEl.style.color = "#e74c3c";
                } else {
                    gameArea.classList.remove('danger');
                    if(taskProgress < taskGoal) {
                        statusEl.innerText = "ä¿æŒå¹³è¡¡ä¸¦å……èƒ½";
                        statusEl.style.color = "white";
                    }
                }
            }
        }

        // é»æ“Šä»»å‹™
        function tapTask(e) {
            e.preventDefault(); // é˜²æ­¢é›™æ“Šç¸®æ”¾
            if (!isPlaying || isPassing) return;

            // é»æ“Šå¹²æ“¾ï¼šæ¯æ¬¡é»æ“Šéƒ½çµ¦çƒä¸€å€‹éš¨æ©Ÿæ¨åŠ›
            velocityX += (Math.random() - 0.5) * 8;
            velocityY += (Math.random() - 0.5) * 8;

            taskProgress++;
            updateProgress();

            // æŒ‰éˆ•å‹•ç•«
            actionBtn.style.transform = "scale(0.9)";
            setTimeout(() => actionBtn.style.transform = "scale(1)", 50);

            if (taskProgress >= taskGoal) {
                triggerPass();
            }
        }

        function updateProgress() {
            const percent = (taskProgress / taskGoal) * 100;
            progressBar.style.width = percent + "%";
            subStatusEl.innerText = `å……èƒ½: ${taskProgress}/${taskGoal}`;
        }

        function triggerPass() {
            // é€²å…¥å‚³éæ¨¡å¼
            isPlaying = false;
            isPassing = true;
            
            statusEl.innerText = "å¿«å‚³çµ¦ä¸‹ä¸€ä½ï¼";
            subStatusEl.innerText = "çƒå·²é–å®š 3 ç§’";
            statusEl.style.color = "#2ecc71";
            gameArea.classList.add('success');
            gameArea.classList.remove('danger');
            
            // é–å®šçƒ
            ball.classList.add('ball-locked');
            
            // éœ‡å‹•æç¤º
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

            // ç¦ç”¨æŒ‰éˆ•
            actionBtn.disabled = true;
            actionBtn.innerText = "å‚³éä¸­...";
            actionBtn.style.background = "#27ae60";

            // 3ç§’å¾Œä¸‹ä¸€ä½é–‹å§‹
            setTimeout(() => {
                nextPlayerReady();
            }, 3000);
        }

        function nextPlayerReady() {
            // é‡ç½®æ•¸å€¼
            ballX = 0; ballY = 0;
            velocityX = 0; velocityY = 0;
            taskProgress = 0;
            updateProgress();
            
            // è§£é™¤é–å®š
            ball.classList.remove('ball-locked');
            gameArea.classList.remove('success');
            
            actionBtn.disabled = false;
            actionBtn.innerText = "é»æˆ‘å……èƒ½";
            actionBtn.style.background = "#e74c3c";
            
            isPassing = false;
            isPlaying = true; // å¼•æ“ç¹¼çºŒæ¥æ‰‹ç‰©ç†è¨ˆç®—
            
            statusEl.innerText = "æ›ä½ æŒ‘æˆ°ï¼";
            subStatusEl.innerText = "ç©©ä½...";
            
            // çµ¦äºˆ 0.5 ç§’çš„ç„¡æ•µæ™‚é–“ï¼Œé¿å…å‰›æ‹¿åˆ°æ‰‹æ˜¯æ­ªçš„å°±æ­»æ‰
            // é€éå¼·åˆ¶æ­¸é›¶é€Ÿåº¦ä¾†å¯¦ç¾
            setTimeout(() => {
                velocityX = 0;
                velocityY = 0;
            }, 500);
        }

        function resetRound() {
            ballX = 0; ballY = 0;
            velocityX = 0; velocityY = 0;
            taskProgress = 0;
            updateProgress();
            failOverlay.style.display = 'none';
            gameArea.classList.remove('danger');
            ball.style.display = 'block';
            isPlaying = true;
            isPassing = false;
            statusEl.innerText = "ä¿æŒå¹³è¡¡";
            subStatusEl.innerText = "é»æ“ŠæŒ‰éˆ•é–‹å§‹å……èƒ½";
        }

        function triggerGameOver() {
            isPlaying = false;
            if (navigator.vibrate) navigator.vibrate(800);
            failOverlay.style.display = 'flex';
        }

        function restartGame() {
            resetRound();
        }
    </script>
</body>
</html>
