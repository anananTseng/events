<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç«¯æ°´éŒ¦æ¨™è³½ V4</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #2c3e50;
            font-family: 'Microsoft JhengHei', sans-serif;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: white;
            user-select: none;
            -webkit-user-select: none;
        }

        /* å…±ç”¨æŒ‰éˆ•æ¨£å¼ */
        button {
            border: none;
            outline: none;
            cursor: pointer;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }

        .btn-primary {
            padding: 15px 30px;
            font-size: 1.2rem;
            background: #3498db;
            color: white;
            border-radius: 10px;
            margin: 5px;
        }

        .btn-success {
            padding: 20px 40px;
            font-size: 1.5rem;
            background: #2ecc71;
            color: white;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* --- éŠæˆ²å€å¡Š --- */
        #game-area {
            position: relative;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border: 8px solid #bdc3c7;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
            z-index: 5;
            display: none; /* é è¨­éš±è— */
        }

        #ball {
            position: absolute;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #3498db, #2980b9);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* ä»‹é¢è³‡è¨Š */
        #hud-layer {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 10;
            display: none;
        }

        #current-player-name {
            font-size: 2rem;
            font-weight: bold;
            color: #f1c40f;
            text-shadow: 2px 2px 0px #000;
        }

        #timer-display {
            font-size: 1.5rem;
            margin-top: 5px;
        }

        /* æ“ä½œå€ */
        #action-area {
            position: absolute;
            bottom: 40px;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 20;
            display: none;
        }

        #action-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 6px solid rgba(255,255,255,0.2);
            background: #e74c3c;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            box-shadow: 0 10px 0 #c0392b;
        }

        #progress-bar-container {
            position: absolute;
            bottom: 20px;
            width: 80%;
            height: 15px;
            background: #34495e;
            border-radius: 10px;
            overflow: hidden;
            display: none;
            border: 1px solid white;
        }
        #progress-bar { width: 0%; height: 100%; background: #2ecc71; transition: width 0.1s; }

        /* --- å„ç¨®å…¨è¢å¹•é é¢ (Overlays) --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        /* 1. ç™»è¨˜é é¢ */
        #setup-screen { z-index: 200; }
        #player-list {
            width: 80%;
            height: 40vh;
            overflow-y: auto;
            background: rgba(0,0,0,0.2);
            margin: 20px 0;
            border-radius: 10px;
            padding: 10px;
            text-align: left;
        }
        .player-tag {
            display: inline-block;
            background: #3498db;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 5px;
            font-size: 1rem;
        }
        input[type="text"] {
            padding: 10px;
            font-size: 1.2rem;
            border-radius: 5px;
            border: none;
            width: 60%;
            text-align: center;
        }

        /* 2. æº–å‚™/æ¥æ£’é é¢ */
        #ready-screen { background: rgba(39, 174, 96, 0.95); display: none; text-align: center;}
        
        /* 3. å€’æ•¸é é¢ */
        #countdown-screen { background: rgba(0,0,0,0.8); display: none; }
        #countdown-text { font-size: 8rem; color: #f1c40f; font-weight: bold; }

        /* 4. å¤±æ•—é é¢ */
        #fail-screen { background: rgba(192, 57, 43, 0.95); display: none; text-align: center; }

        /* 5. çµç®—é é¢ */
        #result-screen { background: #8e44ad; display: none; z-index: 300; }
        #leaderboard {
            width: 90%;
            max-height: 60vh;
            overflow-y: auto;
            background: white;
            color: #333;
            border-radius: 10px;
            padding: 10px;
            margin: 20px 0;
        }
        .rank-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 1.2rem;
        }
        .rank-row:nth-child(1) { background: #f1c40f; font-weight: bold; } /* å† è»é‡‘è‰² */
        .rank-row:nth-child(2) { background: #bdc3c7; } /* äºè»éŠ€è‰² */
        .rank-row:nth-child(3) { background: #d35400; color: white; } /* å­£è»éŠ…è‰² */
        
        .danger { border-color: #e74c3c !important; }

    </style>
</head>
<body>

    <div id="setup-screen" class="overlay">
        <h1>ğŸ“ åƒè³½è€…ç™»è¨˜</h1>
        <div style="width: 100%; text-align: center;">
            <input type="text" id="input-name" placeholder="è¼¸å…¥åå­—" maxlength="6">
            <button class="btn-primary" onclick="addPlayer()">åŠ å…¥</button>
        </div>
        <div id="player-list"></div>
        <p style="color: #bdc3c7; font-size: 0.9rem;">è‡³å°‘éœ€è¦ 1 äºº</p>
        <button class="btn-success" onclick="startTournament()">é–‹å§‹éŒ¦æ¨™è³½</button>
    </div>

    <div id="ready-screen" class="overlay">
        <h2 style="margin:0;">ä¸‹ä¸€ä½é¸æ‰‹</h2>
        <h1 id="ready-player-name" style="font-size: 4rem; margin: 20px 0; color: #fff;"></h1>
        <p>è«‹æ¥éæ‰‹æ©Ÿï¼Œä¿æŒæ°´å¹³</p>
        <button class="btn-success" style="background: white; color: #27ae60;" onclick="startCountdownSequence()">æˆ‘æº–å‚™å¥½äº†ï¼</button>
    </div>

    <div id="countdown-screen" class="overlay">
        <div id="countdown-text">3</div>
    </div>

    <div id="fail-screen" class="overlay">
        <h1 style="font-size: 4rem;">ğŸ’” ç¢äº†ï¼</h1>
        <p style="font-size: 1.5rem;">æˆç¸¾ï¼šæ·˜æ±°</p>
        <button class="btn-success" onclick="nextPlayer()">æ›ä¸‹ä¸€ä½</button>
    </div>

    <div id="result-screen" class="overlay">
        <h1>ğŸ† æ¯”è³½çµæœ</h1>
        <div id="leaderboard">
            </div>
        <button class="btn-primary" onclick="location.reload()">é‡æ–°ä¸€å±€</button>
    </div>

    <div id="hud-layer">
        <div id="current-player-name">Player</div>
        <div id="timer-display">0.00 ç§’</div>
    </div>

    <div id="game-area">
        <div id="ball"></div>
    </div>

    <div id="progress-bar-container"><div id="progress-bar"></div></div>
    
    <div id="action-area">
        <button id="action-btn" ontouchstart="tapTask(event)" onclick="tapTask(event)">é»æ“Š<br>å……èƒ½</button>
    </div>

    <script>
        // --- è³‡æ–™çµæ§‹ ---
        let players = []; // { name: "Andy", time: 999, status: "pending/success/fail" }
        let currentPlayerIndex = 0;
        let startTime = 0;
        let timerInterval;

        // --- DOM ---
        const setupScreen = document.getElementById('setup-screen');
        const readyScreen = document.getElementById('ready-screen');
        const countdownScreen = document.getElementById('countdown-screen');
        const failScreen = document.getElementById('fail-screen');
        const resultScreen = document.getElementById('result-screen');
        
        const gameArea = document.getElementById('game-area');
        const hudLayer = document.getElementById('hud-layer');
        const actionArea = document.getElementById('action-area');
        const progressBarContainer = document.getElementById('progress-bar-container');
        
        const inputName = document.getElementById('input-name');
        const playerList = document.getElementById('player-list');
        const readyPlayerName = document.getElementById('ready-player-name');
        
        // éŠæˆ²ç‰©ç†è®Šæ•¸
        const ball = document.getElementById('ball');
        const progressBar = document.getElementById('progress-bar');
        const timerDisplay = document.getElementById('timer-display');
        const actionBtn = document.getElementById('action-btn');

        let isPlaying = false;
        let ballX = 0, ballY = 0;
        let velocityX = 0, velocityY = 0;
        let tiltX = 0, tiltY = 0;
        let taskProgress = 0;
        const taskGoal = 10;
        const maxRadius = 120;

        // --- 1. ç™»è¨˜éšæ®µé‚è¼¯ ---
        function addPlayer() {
            const name = inputName.value.trim();
            if (name) {
                players.push({ name: name, time: 0, status: 'pending' });
                updatePlayerList();
                inputName.value = '';
                inputName.focus();
            }
        }

        function updatePlayerList() {
            playerList.innerHTML = players.map((p, i) => 
                `<span class="player-tag">${i+1}. ${p.name}</span>`
            ).join('');
        }

        function startTournament() {
            if (players.length === 0) {
                alert("è«‹è‡³å°‘è¼¸å…¥ä¸€ä½ç©å®¶ï¼");
                return;
            }
            // è«‹æ±‚æ¬Šé™
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            beginGameFlow();
                        } else {
                            alert("éœ€è¦æ¬Šé™æ‰èƒ½ç©ï¼");
                        }
                    })
                    .catch(console.error);
            } else {
                beginGameFlow();
            }
        }

        function beginGameFlow() {
            setupScreen.style.display = 'none';
            // å•Ÿå‹•ç‰©ç†å¼•æ“
            window.addEventListener('deviceorientation', handleOrientation);
            requestAnimationFrame(gameLoop);
            
            currentPlayerIndex = 0;
            showReadyScreen();
        }

        // --- 2. å›åˆæµç¨‹æ§åˆ¶ ---

        function showReadyScreen() {
            // éš±è—éŠæˆ²ä»‹é¢
            gameArea.style.display = 'none';
            hudLayer.style.display = 'none';
            actionArea.style.display = 'none';
            progressBarContainer.style.display = 'none';
            failScreen.style.display = 'none';
            
            // é¡¯ç¤ºæº–å‚™ç•«é¢
            const player = players[currentPlayerIndex];
            readyPlayerName.innerText = player.name;
            readyScreen.style.display = 'flex';
        }

        function startCountdownSequence() {
            readyScreen.style.display = 'none';
            countdownScreen.style.display = 'flex';
            
            // é‡ç½®éŠæˆ²åƒæ•¸
            ballX = 0; ballY = 0; velocityX = 0; velocityY = 0;
            taskProgress = 0;
            updateProgress();
            gameArea.classList.remove('danger');
            
            let count = 3;
            document.getElementById('countdown-text').innerText = count;
            
            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    document.getElementById('countdown-text').innerText = count;
                    if(navigator.vibrate) navigator.vibrate(50);
                } else {
                    clearInterval(timer);
                    startGameplay();
                }
            }, 1000);
        }

        function startGameplay() {
            countdownScreen.style.display = 'none';
            
            // é¡¯ç¤ºéŠæˆ²UI
            gameArea.style.display = 'block';
            hudLayer.style.display = 'block';
            actionArea.style.display = 'flex';
            progressBarContainer.style.display = 'block';
            document.getElementById('current-player-name').innerText = players[currentPlayerIndex].name;
            
            isPlaying = true;
            startTime = Date.now();
            
            // å•Ÿå‹•è¨ˆæ™‚å™¨é¡¯ç¤º
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                timerDisplay.innerText = elapsed.toFixed(2) + " ç§’";
            }, 100);

            if(navigator.vibrate) navigator.vibrate(200);
        }

        function finishTurn(success) {
            isPlaying = false;
            clearInterval(timerInterval);
            
            const player = players[currentPlayerIndex];
            
            if (success) {
                const finalTime = (Date.now() - startTime) / 1000;
                player.time = finalTime;
                player.status = 'success';
                // ç›´æ¥æ›ä¸‹ä¸€ä½ï¼Œæˆ–é¡¯ç¤ºéé—œå‹•ç•« (é€™è£¡ç°¡åŒ–ç›´æ¥æ›äºº)
                nextPlayer();
            } else {
                player.time = 9999; // æ‡²ç½°æ™‚é–“
                player.status = 'fail';
                if(navigator.vibrate) navigator.vibrate(1000);
                failScreen.style.display = 'flex';
            }
        }

        function nextPlayer() {
            currentPlayerIndex++;
            if (currentPlayerIndex < players.length) {
                showReadyScreen();
            } else {
                showResultScreen();
            }
        }

        // --- 3. éŠæˆ²ç‰©ç†èˆ‡æ“ä½œ (ç¹¼æ‰¿è‡ª V3) ---
        
        function handleOrientation(event) {
            let x = event.gamma; 
            let y = event.beta;
            if (x > 45) x = 45; if (x < -45) x = -45;
            if (y > 45) y = 45; if (y < -45) y = -45;
            tiltX = x;
            tiltY = y;
        }

        function gameLoop() {
            requestAnimationFrame(gameLoop);
            if (!isPlaying) return;

            velocityX += tiltX * 0.05;
            velocityY += tiltY * 0.05;
            velocityX *= 0.92;
            velocityY *= 0.92;
            ballX += velocityX;
            ballY += velocityY;

            const dist = Math.sqrt(ballX * ballX + ballY * ballY);

            if (dist > maxRadius) {
                finishTurn(false); // å¤±æ•—
            } else {
                ball.style.transform = `translate(calc(-50% + ${ballX}px), calc(-50% + ${ballY}px))`;
                if (dist > maxRadius * 0.75) {
                    gameArea.classList.add('danger');
                    timerDisplay.style.color = "#e74c3c";
                } else {
                    gameArea.classList.remove('danger');
                    timerDisplay.style.color = "white";
                }
            }
        }

        function tapTask(e) {
            e.preventDefault();
            if (!isPlaying) return;

            velocityX += (Math.random() - 0.5) * 8; // é»æ“Šå¹²æ“¾
            velocityY += (Math.random() - 0.5) * 8;
            taskProgress++;
            updateProgress();

            // æŒ‰éˆ•å‹•ç•«
            actionBtn.style.transform = "scale(0.9)";
            setTimeout(() => actionBtn.style.transform = "scale(1)", 50);

            if (taskProgress >= taskGoal) {
                finishTurn(true); // æˆåŠŸ
            }
        }

        function updateProgress() {
            const percent = (taskProgress / taskGoal) * 100;
            progressBar.style.width = percent + "%";
        }

        // --- 4. çµç®—æ’è¡Œæ¦œ ---
        function showResultScreen() {
            gameArea.style.display = 'none';
            hudLayer.style.display = 'none';
            actionArea.style.display = 'none';
            progressBarContainer.style.display = 'none';
            failScreen.style.display = 'none';
            resultScreen.style.display = 'flex';

            // æ’åºï¼šæˆåŠŸçš„æŒ‰æ™‚é–“æ’ï¼Œå¤±æ•—çš„æ’å¾Œé¢
            players.sort((a, b) => a.time - b.time);

            let html = '';
            players.forEach((p, index) => {
                let timeStr = p.status === 'fail' ? 'æ·˜æ±°' : p.time.toFixed(2) + 'ç§’';
                let rank = index + 1;
                let medal = '';
                if (index === 0) medal = 'ğŸ¥‡';
                if (index === 1) medal = 'ğŸ¥ˆ';
                if (index === 2) medal = 'ğŸ¥‰';

                html += `
                    <div class="rank-row">
                        <span>${medal} ${rank}. ${p.name}</span>
                        <span>${timeStr}</span>
                    </div>
                `;
            });
            document.getElementById('leaderboard').innerHTML = html;
        }

    </script>
</body>
</html>
