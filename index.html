<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç«¯æ°´å¤§æŒ‘æˆ° V3 (å®‰å…¨æ¥åŠ›ç‰ˆ)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #2c3e50;
            font-family: 'Microsoft JhengHei', sans-serif;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: white;
            user-select: none;
            -webkit-user-select: none;
        }

        /* éŠæˆ²ä¸»åœ“ç›¤ */
        #game-area {
            position: relative;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border: 8px solid #bdc3c7;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
            transition: border-color 0.2s, background-color 0.2s;
            z-index: 5;
        }

        #ball {
            position: absolute;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #3498db, #2980b9);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 6;
        }

        /* ä»‹é¢æ–‡å­—å±¤ */
        #ui-layer {
            position: absolute;
            top: 40px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 10;
        }

        #status {
            font-size: 1.8rem;
            font-weight: 900;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        #sub-status {
            font-size: 1.2rem;
            color: #f1c40f;
            text-shadow: 1px 1px 2px black;
        }

        /* åº•éƒ¨æ“ä½œå€ */
        #action-area {
            position: absolute;
            bottom: 60px;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 20;
        }

        /* å……èƒ½æŒ‰éˆ• */
        #action-btn {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            border: 6px solid rgba(255,255,255,0.2);
            background: #e74c3c;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 10px 0 #c0392b, 0 10px 20px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: transform 0.1s;
            display: none; 
        }
        
        #action-btn:active {
            transform: translateY(5px);
            box-shadow: 0 5px 0 #c0392b;
        }

        /* é€²åº¦æ¢ */
        #progress-bar-container {
            position: absolute;
            bottom: 30px;
            width: 80%;
            height: 15px;
            background: #34495e;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.2);
            display: none;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background: #2ecc71;
            transition: width 0.1s;
        }

        /* å…¨è¢å¹•è¦†è“‹å±¤ (é–‹å§‹/å‚³é/å€’æ•¸/å¤±æ•—) */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(5px);
            transition: opacity 0.3s;
        }

        #start-overlay { background: rgba(44, 62, 80, 0.95); }
        #fail-overlay { background: rgba(192, 57, 43, 0.95); display: none; }
        
        /* å‚³éå®‰å…¨æ¨¡å¼è¦†è“‹å±¤ */
        #pass-overlay { 
            background: rgba(39, 174, 96, 0.95); 
            display: none; 
        }

        /* å€’æ•¸è¨ˆæ™‚è¦†è“‹å±¤ */
        #countdown-overlay {
            background: rgba(0,0,0,0.6);
            display: none;
        }

        #countdown-text {
            font-size: 8rem;
            font-weight: bold;
            color: #f1c40f;
            animation: pulse 0.5s infinite alternate;
        }

        .btn-large {
            padding: 20px 50px;
            font-size: 1.5rem;
            background: #f1c40f;
            color: #2c3e50;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            margin-top: 20px;
        }

        .btn-ready {
            padding: 30px 40px;
            font-size: 2rem;
            background: white;
            color: #27ae60;
            border: none;
            border-radius: 20px;
            font-weight: 900;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            cursor: pointer;
            animation: float 2s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .danger { border-color: #e74c3c !important; background: rgba(231, 76, 60, 0.3) !important; }

    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="status">æº–å‚™é–‹å§‹</div>
        <div id="sub-status">è«‹ä¿æŒæ‰‹æ©Ÿæ°´å¹³</div>
    </div>

    <div id="game-area">
        <div id="ball"></div>
    </div>

    <div id="progress-bar-container">
        <div id="progress-bar"></div>
    </div>

    <div id="action-area">
        <button id="action-btn" ontouchstart="tapTask(event)" onclick="tapTask(event)">é»æˆ‘<br>å……èƒ½</button>
    </div>

    <div id="start-overlay" class="overlay">
        <h1 style="font-size: 2.5rem; margin-bottom: 10px;">âš–ï¸ ç«¯æ°´å¤§æŒ‘æˆ° V3</h1>
        <p>1. å¹³æ”¾æ‰‹æ©Ÿ<br>2. é»æ“ŠæŒ‰éˆ•å……èƒ½<br>3. å®‰å…¨å‚³çµ¦ä¸‹ä¸€ä½</p>
        <button class="btn-large" onclick="requestPermission()">é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="pass-overlay" class="overlay">
        <h1 style="font-size: 3rem; margin:0;">âœ… å®‰å…¨æ¨¡å¼</h1>
        <p style="font-size: 1.2rem; margin: 20px 0;">ç¾åœ¨å¯ä»¥å®‰å¿ƒå‚³çµ¦ä¸‹ä¸€ä½</p>
        <p>ä¸‹ä¸€ä½æ‹¿åˆ°å¾Œè«‹æŒ‰ä¸‹æ–¹æŒ‰éˆ•</p>
        <button class="btn-ready" onclick="startReadySequence()">æˆ‘æ‹¿å¥½äº†ï¼</button>
    </div>

    <div id="countdown-overlay" class="overlay">
        <div id="countdown-text">3</div>
        <p style="color:white; margin-top:20px;">ç©©ä½...</p>
    </div>

    <div id="fail-overlay" class="overlay">
        <h1 style="font-size: 4rem; margin:0;">ğŸ’¥</h1>
        <h2>ç¢æ‰äº†ï¼</h2>
        <button class="btn-large" onclick="restartGame()">é‡æ–°é–‹å§‹</button>
    </div>

    <script>
        // DOM å…ƒç´ 
        const ball = document.getElementById('ball');
        const gameArea = document.getElementById('game-area');
        const statusEl = document.getElementById('status');
        const subStatusEl = document.getElementById('sub-status');
        const actionBtn = document.getElementById('action-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-bar-container');
        
        // Overlays
        const startOverlay = document.getElementById('start-overlay');
        const failOverlay = document.getElementById('fail-overlay');
        const passOverlay = document.getElementById('pass-overlay');
        const countdownOverlay = document.getElementById('countdown-overlay');
        const countdownText = document.getElementById('countdown-text');

        // éŠæˆ²ç‹€æ…‹
        let isPlaying = false; // æ˜¯å¦æ­£åœ¨é€²è¡Œç‰©ç†é‹ç®—
        let ballX = 0, ballY = 0;
        let velocityX = 0, velocityY = 0;
        let tiltX = 0, tiltY = 0;
        const maxRadius = 120;
        
        let taskProgress = 0;
        const taskGoal = 10;

        // iOS æ¬Šé™
        function requestPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            initGame();
                        } else {
                            alert('éœ€è¦å‹•ä½œåµæ¸¬æ¬Šé™æ‰èƒ½éŠç©å–”ï¼');
                        }
                    })
                    .catch(console.error);
            } else {
                initGame();
            }
        }

        function initGame() {
            startOverlay.style.display = 'none';
            actionBtn.style.display = 'block';
            progressContainer.style.display = 'block';
            
            window.addEventListener('deviceorientation', handleOrientation);
            requestAnimationFrame(gameLoop); // å•Ÿå‹•æ°¸ä¹…å¼•æ“
            
            startReadySequence(); // ç¬¬ä¸€æ¬¡ä¹Ÿé€²å…¥å€’æ•¸æµç¨‹
        }

        function handleOrientation(event) {
            let x = event.gamma; 
            let y = event.beta;
            // é™åˆ¶æœ€å¤§å‚¾æ–œ
            if (x > 45) x = 45; if (x < -45) x = -45;
            if (y > 45) y = 45; if (y < -45) y = -45;
            tiltX = x;
            tiltY = y;
        }

        function gameLoop() {
            requestAnimationFrame(gameLoop);

            // åªæœ‰åœ¨ isPlaying ç‚º true æ™‚æ‰æ›´æ–°çƒçš„ä½ç½®
            if (!isPlaying) return;

            // ç‰©ç†è¨ˆç®—
            velocityX += tiltX * 0.05;
            velocityY += tiltY * 0.05;
            velocityX *= 0.92; // æ‘©æ“¦åŠ›
            velocityY *= 0.92;

            ballX += velocityX;
            ballY += velocityY;

            const dist = Math.sqrt(ballX * ballX + ballY * ballY);

            // é‚Šç•Œæª¢æ¸¬
            if (dist > maxRadius) {
                triggerGameOver();
            } else {
                ball.style.transform = `translate(calc(-50% + ${ballX}px), calc(-50% + ${ballY}px))`;
                
                // å±éšªè­¦ç¤º
                if (dist > maxRadius * 0.75) {
                    gameArea.classList.add('danger');
                    statusEl.innerText = "å±éšªï¼ï¼å›æ­£ï¼ï¼";
                    statusEl.style.color = "#e74c3c";
                } else {
                    gameArea.classList.remove('danger');
                    statusEl.innerText = "ä¿æŒå¹³è¡¡ä¸¦å……èƒ½";
                    statusEl.style.color = "white";
                }
            }
        }

        function tapTask(e) {
            e.preventDefault();
            if (!isPlaying) return;

            // é»æ“Šå¹²æ“¾
            velocityX += (Math.random() - 0.5) * 8;
            velocityY += (Math.random() - 0.5) * 8;

            taskProgress++;
            updateProgress();

            // æŒ‰éˆ•åé¥‹
            actionBtn.style.transform = "scale(0.9)";
            setTimeout(() => actionBtn.style.transform = "scale(1)", 50);

            if (taskProgress >= taskGoal) {
                triggerPassMode();
            }
        }

        function updateProgress() {
            const percent = (taskProgress / taskGoal) * 100;
            progressBar.style.width = percent + "%";
            subStatusEl.innerText = `å……èƒ½: ${taskProgress}/${taskGoal}`;
        }

        // --- æ–°çš„æ ¸å¿ƒæ©Ÿåˆ¶ ---

        // 1. è§¸ç™¼å‚³éæ¨¡å¼ (å®‰å…¨æ¨¡å¼)
        function triggerPassMode() {
            isPlaying = false; // åœæ­¢ç‰©ç†é‹ç®—ï¼Œçƒå®šæ ¼
            
            // è¦–è¦ºå›é¥‹
            passOverlay.style.display = 'flex'; // é¡¯ç¤ºç¶ è‰²å…¨è¢å¹•
            if (navigator.vibrate) navigator.vibrate([100, 100, 100]); // æˆåŠŸéœ‡å‹•
        }

        // 2. ä¸‹ä¸€ä½ç©å®¶æŒ‰ä¸‹ã€Œæˆ‘æ‹¿å¥½äº†ã€-> å•Ÿå‹•å€’æ•¸
        function startReadySequence() {
            passOverlay.style.display = 'none'; // éš±è—å‚³éå±¤
            countdownOverlay.style.display = 'flex'; // é¡¯ç¤ºå€’æ•¸å±¤
            
            // é‡ç½®çƒçš„ä½ç½®åˆ°ä¸­å¿ƒ (çµ¦äºˆå…¬å¹³çš„é–‹å§‹)
            ballX = 0; ballY = 0;
            velocityX = 0; velocityY = 0;
            ball.style.transform = `translate(-50%, -50%)`;
            
            // é‡ç½®ä»»å‹™é€²åº¦
            taskProgress = 0;
            updateProgress();

            // å€’æ•¸è¨ˆæ™‚é‚è¼¯
            let count = 3;
            countdownText.innerText = count;
            
            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownText.innerText = count;
                    if (navigator.vibrate) navigator.vibrate(50);
                } else {
                    clearInterval(timer);
                    startGameplay();
                }
            }, 1000);
        }

        // 3. æ­£å¼é–‹å§‹éŠç©
        function startGameplay() {
            countdownOverlay.style.display = 'none';
            isPlaying = true;
            statusEl.innerText = "ä¿æŒå¹³è¡¡";
            if (navigator.vibrate) navigator.vibrate(200); // é–‹å§‹é•·éœ‡å‹•æç¤º
        }

        function triggerGameOver() {
            isPlaying = false;
            failOverlay.style.display = 'flex';
            if (navigator.vibrate) navigator.vibrate(1000);
        }

        function restartGame() {
            failOverlay.style.display = 'none';
            // é‡æ–°é–‹å§‹ä¹Ÿé€²å…¥å€’æ•¸æµç¨‹
            startReadySequence();
        }
    </script>
</body>
</html>
