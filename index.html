<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çµ‚æ¥µè²æ§ç‚¸å½ˆ</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: manipulation;
            transition: background-color 0.5s;
        }

        /* å±éšªç‹€æ…‹èƒŒæ™¯è‰² */
        body.stage-warning { background-color: #d35400; }
        body.stage-danger { background-color: #c0392b; animation: flash-red 0.5s infinite; }
        body.exploded { background-color: #000; }

        @keyframes flash-red {
            0% { background-color: #c0392b; }
            50% { background-color: #e74c3c; }
            100% { background-color: #c0392b; }
        }

        h1 { margin: 0 0 20px 0; font-size: 1.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }

        #bomb-emoji {
            font-size: 120px;
            margin: 10px 0;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
            transition: transform 0.1s;
        }

        .shake-mild { animation: shake 0.8s infinite; }
        .shake-crazy { animation: shake 0.2s infinite; }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            25% { transform: translate(-2px, -2px) rotate(-2deg); }
            50% { transform: translate(2px, 0px) rotate(2deg); }
            75% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(0px, 0px) rotate(0deg); }
        }

        #status-text {
            font-size: 1.2rem;
            min-height: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #penalty-box {
            display: none;
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 15px;
            width: 80%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 10;
            animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop-in {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        #penalty-text {
            font-size: 1.8rem;
            font-weight: 900;
            color: #e74c3c;
            margin: 10px 0;
        }

        button {
            padding: 15px 40px;
            font-size: 1.3rem;
            background: linear-gradient(145deg, #f1c40f, #f39c12);
            color: #2c3e50;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin-top: 20px;
        }
        button:active { transform: scale(0.95); }
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <h1>ğŸ”¥ æ¥µé€Ÿå‚³ç‚¸å½ˆ</h1>

    <div id="status-text">æº–å‚™å¥½äº†å—ï¼Ÿ</div>
    
    <div id="bomb-emoji">ğŸ’£</div>

    <div id="penalty-box">
        <h3>ğŸ’¥ çˆ†ç‚¸äº†ï¼</h3>
        <p>è«‹æ¥å—æ‡²ç½°ï¼š</p>
        <div id="penalty-text">æŠ½å–ä¸­...</div>
        <button onclick="resetGame()">ä¸‹ä¸€å±€</button>
    </div>

    <button id="start-btn" onclick="initGame()">é»æˆ‘é–‹å§‹</button>

    <script>
        // éŠæˆ²è®Šæ•¸
        let recognition;
        let isGameRunning = false;
        let explodeTimer;
        let beepInterval;
        let totalTime = 0;
        let timeElapsed = 0;
        let audioCtx; // éŸ³æ•ˆä¸Šä¸‹æ–‡

        // DOM å…ƒç´ 
        const body = document.body;
        const bombEl = document.getElementById('bomb-emoji');
        const statusEl = document.getElementById('status-text');
        const startBtn = document.getElementById('start-btn');
        const penaltyBox = document.getElementById('penalty-box');
        const penaltyText = document.getElementById('penalty-text');

        // æ‡²ç½°åˆ—è¡¨ (é©åˆå°å­¸ç”Ÿ)
        const penalties = [
            "å­¸ç‹—å«ä¸‰è² ğŸ¶",
            "åšé¬¼è‡‰åç§’é˜ ğŸ¤ª",
            "å±è‚¡å¯«å­—ï¼šæˆ‘æ„›ä½  ğŸ‘",
            "åŸåœ°è½‰äº”åœˆ ğŸŒ€",
            "å­¸æ©Ÿå™¨äººèªªè©± ğŸ¤–",
            "è·Ÿå³é‚Šçš„äººæ¡æ‰‹èªªä½ å¥½ ğŸ‘‹",
            "æ·±è¹²ä¸‰æ¬¡ ğŸ‹ï¸",
            "æ“ºä¸€å€‹å¸¥æ°£çš„å§¿å‹¢ âœ¨",
            "æ¨¡ä»¿çŒ´å­æŠ“ç™¢ ğŸ’",
            "å¤§å–Šï¼šæˆ‘æ˜¯è¶…ç´šå¤§å¸¥å“¥/ç¾å¥³ ğŸ“¢"
        ];

        // 1. åˆå§‹åŒ–èªéŸ³è­˜åˆ¥
        function setupRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'zh-TW';

                recognition.onresult = (event) => {
                    if (!isGameRunning) return;
                    const transcript = event.results[event.results.length - 1][0].transcript.trim();
                    if (transcript.length > 0) triggerPassEffect();
                };
                
                recognition.onend = () => { if (isGameRunning) recognition.start(); };
            } else {
                alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³ï¼Œè«‹ä½¿ç”¨ Chrome æˆ– Safariã€‚");
            }
        }

        // 2. ç”¢ç”Ÿå—¶å—¶è² (Web Audio APIï¼Œä¸ç”¨ä¸‹è¼‰æª”æ¡ˆ)
        function playBeep(freq = 800, duration = 0.1) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
            osc.stop(audioCtx.currentTime + duration);
        }

        function playExplosion() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);
            gain.gain.setValueAtTime(1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 1);
        }

        // 3. éŠæˆ²é‚è¼¯
        function initGame() {
            // åˆå§‹åŒ–éŸ³æ•ˆç’°å¢ƒ (å¿…é ˆç”±ç”¨æˆ¶é»æ“Šè§¸ç™¼)
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            setupRecognition();
            startGame();
        }

        function startGame() {
            isGameRunning = true;
            timeElapsed = 0;
            totalTime = Math.floor(Math.random() * 30000) + 15000; // 15~45ç§’éš¨æ©Ÿ
            
            // ä»‹é¢é‡ç½®
            startBtn.classList.add('hidden');
            penaltyBox.style.display = 'none';
            bombEl.innerText = "ğŸ’£";
            bombEl.classList.add('shake-mild');
            statusEl.innerText = "å¿«èªªç­”æ¡ˆå‚³çµ¦ä¸‹ä¸€ä½ï¼";
            body.className = ''; 

            try { recognition.start(); } catch(e) {}

            // éŠæˆ²è¿´åœˆ (è™•ç†è¨ˆæ™‚èˆ‡éŸ³æ•ˆåŠ é€Ÿ)
            clearInterval(beepInterval);
            let beepRate = 1000; // åˆå§‹ä¸€ç§’å—¶ä¸€æ¬¡
            
            const gameLoop = () => {
                if (!isGameRunning) return;
                
                timeElapsed += beepRate;
                const percent = timeElapsed / totalTime;

                // æ’­æ”¾éŸ³æ•ˆ
                playBeep(800 + (percent * 500)); // éŸ³èª¿è¶Šä¾†è¶Šé«˜

                // è¦–è¦ºæ•ˆæœè®ŠåŒ–
                if (percent > 0.5) body.className = 'stage-warning'; // è®Šæ©˜è‰²
                if (percent > 0.8) {
                    body.className = 'stage-danger'; // è®Šç´…è‰²é–ƒçˆ
                    bombEl.classList.remove('shake-mild');
                    bombEl.classList.add('shake-crazy'); // åŠ‡çƒˆæ–æ™ƒ
                }

                // èª¿æ•´ä¸‹ä¸€è²å—¶å—¶çš„é€Ÿåº¦ (è¶Šä¾†è¶Šå¿«)
                let nextInterval = 1000 - (percent * 900); // æœ€å¿« 0.1ç§’å—¶ä¸€æ¬¡
                if (nextInterval < 100) nextInterval = 100;

                // æª¢æŸ¥æ˜¯å¦çˆ†ç‚¸
                if (timeElapsed >= totalTime) {
                    explode();
                } else {
                    beepInterval = setTimeout(gameLoop, nextInterval);
                }
            };

            gameLoop();
        }

        // 4. èªéŸ³è§¸ç™¼ç‰¹æ•ˆ
        function triggerPassEffect() {
            statusEl.innerText = "æ”¶åˆ°ï¼å¿«å‚³ï¼";
            statusEl.style.color = "#f1c40f";
            bombEl.style.transform = "scale(1.3)";
            if (navigator.vibrate) navigator.vibrate(50); // çŸ­éœ‡å‹•
            
            setTimeout(() => {
                statusEl.innerText = "ä¸‹ä¸€å€‹ï¼";
                statusEl.style.color = "white";
                bombEl.style.transform = "scale(1)";
            }, 300);
        }

        // 5. çˆ†ç‚¸èˆ‡æ‡²ç½°
        function explode() {
            isGameRunning = false;
            clearTimeout(beepInterval);
            recognition.stop();

            playExplosion();
            if (navigator.vibrate) navigator.vibrate([500, 100, 500, 100, 1000]); // é•·éœ‡å‹•

            body.className = 'exploded';
            bombEl.innerText = "ğŸ’¥";
            bombEl.classList.remove('shake-crazy');
            statusEl.innerText = "";

            // é¡¯ç¤ºæ‡²ç½°
            setTimeout(() => {
                const randomPenalty = penalties[Math.floor(Math.random() * penalties.length)];
                penaltyText.innerText = randomPenalty;
                penaltyBox.style.display = 'block';
            }, 1000);
        }

        function resetGame() {
            penaltyBox.style.display = 'none';
            startBtn.classList.remove('hidden');
            startBtn.innerText = "å†ä¾†ä¸€å±€";
            body.className = '';
            bombEl.innerText = "ğŸ’£";
            statusEl.innerText = "æº–å‚™é–‹å§‹";
        }
    </script>
</body>
</html>
